<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Modern Product Registry Demo with Admin OTP Generation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {background: #f2f7fa; font-family:'Montserrat',Arial,sans-serif;}
    .card {background:#fff;max-width:420px;margin:38px auto;border-radius:18px;box-shadow:0 6px 28px #b0b6d6aa;
      padding:33px 22px;}
    h1{color:#2c52d5;font-size:2.1rem;text-align:center;font-weight:800;margin-bottom:10px;}
    .step{margin-top:15px;padding:11px 6px 3px 6px;}
    label{font-weight:600; margin-top:12px;display:block;}
    input,button,textarea{width:100%;font-size:1.02rem;padding:10px 13px;margin-top:6px;margin-bottom:13px;
      border-radius:7px;border:1.1px solid #bcd9ef;background:#f6f8fc;font-family:inherit;}
    input:focus,textarea:focus{border-color:#2274f7;}
    button{background:linear-gradient(90deg,#2873e5 80%,#633de7);color:white;font-weight:700;border:none;margin-top:6px;}
    button:disabled {background:#bdd4f4;}
    .status{font-weight:700;margin:5px 0 7px 0;padding:8px 10px;border-radius:6px;}
    .success{color:#167536!important;background:#e7fae9;}
    .error{color:#a12020!important;background:#fce9e7;}
    .hide{display:none!important;}
    #qr-reader{margin:7px auto 10px auto;width:98%;max-width:295px;}
    .btnrow{display:flex;gap:9px;margin-top:12px;}
    @media (max-width:500px){.card{padding:7px 2vw;}}
  </style>
</head>
<body>
<div class="card">
  <h1>Product Registry</h1>

  <!-- Step 1: Login -->
  <div class="step" id="loginStep">
    <label>Username</label><input id="loginUser" autocomplete="username"/>
    <label>Password</label><input id="loginPwd" type="password" autocomplete="current-password"/>
    <button id="loginBtn">Login</button>
    <div id="loginMsg" class="status hide"></div>
  </div>

  <!-- Step 1.5: Admin OTP Generation (for demo, only admin wallet connected) -->
  <div class="step hide" id="adminOtpStep">
    <h3>Admin: Generate Registration OTP</h3>
    <label>User Wallet Address</label>
    <input id="adminUserAddr" placeholder="0xUserWalletAddress"/>
    <button id="generateOtpBtn">Generate OTP</button>
    <div id="generatedOtpMsg" class="status hide"></div>
  </div>

  <!-- Step 2: Wallet -->
  <div class="step hide" id="walletStep">
    <button id="connectBtn">ðŸ”‘ Connect MetaMask Wallet</button>
    <span id="walletDisp" style="display:block;margin-top:3px;color:#238454;font-weight:600;"></span>
    <div id="walletMsg" class="status hide"></div>
  </div>

  <!-- Step 3: OTP to unlock Registration -->
  <div class="step hide" id="otpStep">
    <label>Registration OTP (from admin)</label>
    <input id="userOtp"/>
    <button id="otpBtn" disabled>Verify OTP to Unlock Registration</button>
    <div id="otpMsg" class="status hide"></div>
  </div>

  <!-- Step 4: Product Registration -->
  <div class="step hide" id="regStep">
    <form id="regForm" autocomplete="off">
      <label>Product ID</label><input id="pid" required />
      <label>Name</label><input id="pname" required />
      <label>Manufacturer</label><input id="manuf" required />
      <label>Manufacture Date</label><input id="mfgdate" type="date" required />
      <button type="submit">Register Product</button>
    </form>
    <div id="regMsg" class="status hide"></div>
  </div>

  <hr style="margin:21px 0;"/>

  <!-- Step 5: Product Verification, Delivery, Fraud -->
  <div class="step hide" id="mainDapp">
    <label>Verify Product (ID or QR):</label>
    <div id="qr-reader"></div>
    <input id="verifyId" placeholder="Enter or scan Product ID"/>
    <button id="verifyBtn" disabled>Verify Product</button>
    <div id="verifyMsg" class="status hide"></div>
    <div class="btnrow">
      <button id="genDelOtpBtn" disabled style="background:#fbe67c;color:#654f02;">Admin: Delivery OTP</button>
      <button id="confDelBtn" disabled style="background:#83efd8;color:#136b47;">Buyer: Confirm Delivery OTP</button>
    </div>
    <button id="fraudBtn" disabled style="margin-top:11px;background:#fadada;color:#c12125;">Report Fraud</button>
    <textarea id="fraudDetails" rows="2" class="hide" placeholder="Describe fraud (optional)"></textarea>
    <div id="fraudMsg" class="status hide"></div>
  </div>
</div>

<script>
const contractABI = [
  {inputs:[{type:"address",name:"user"},{type:"bytes32",name:"otpHash"}],name:"generateRegistrationOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"otp"}],name:"verifyUserOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"productName"},{type:"string",name:"manufacturer"},{type:"uint256",name:"mfgDate"}],name:"registerProduct",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"}],name:"verifyProduct",outputs:[
    {type:"bool",name:"exists"},{type:"string",name:"name"},{type:"string",name:"manufacturer"},{type:"uint256",name:"manufactureDate"},{type:"bool",name:"delivered"},{type:"address",name:"recipient"}],stateMutability:"view",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"address",name:"recipient"},{type:"bytes32",name:"otpHash"}],name:"generateDeliveryOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"otp"}],name:"confirmDelivery",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"details"}],name:"reportFraud",outputs:[],stateMutability:"nonpayable",type:"function"}
];
// ðŸ‘‡ Replace with your deployed contract address!
const contractAddress = "0xf94ac6fe1bc75a7462cc5f7f9e14a5d281f1b46b";

let web3, contract, userAccount, otpVerified = false;

// --- Login ---
document.getElementById("loginBtn").onclick = function() {
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPwd").value.trim();
  let m = document.getElementById("loginMsg");
  if(username === "user" && password === "password123") {
    document.getElementById("loginStep").classList.add("hide");
    document.getElementById("walletStep").classList.remove("hide");
    m.classList.add("hide");
  } else if(username === "admin" && password === "admin123") {
    // Admin login to show OTP generation UI
    document.getElementById("loginStep").classList.add("hide");
    document.getElementById("walletStep").classList.remove("hide");
    document.getElementById("adminOtpStep").classList.remove("hide");
    m.classList.add("hide");
  } else {
    m.textContent = "Invalid username or password.";
    m.className = "status error";
    m.classList.remove("hide");
  }
};

// --- Wallet ---
document.getElementById("connectBtn").onclick = async () => {
  if(!window.ethereum) return alert("Please install MetaMask");
  web3 = new Web3(window.ethereum);
  try {
    let accounts = await ethereum.request({ method: "eth_requestAccounts" });
    userAccount = accounts[0];
    contract = new web3.eth.Contract(contractABI, contractAddress);
    document.getElementById("walletDisp").textContent = userAccount.slice(0,6) + "..." + userAccount.slice(-4);
    document.getElementById("walletStep").classList.add("hide");
    // If admin OTP generation UI visible, keep it visible, else show user OTP step
    if(!document.getElementById("adminOtpStep").classList.contains("hide")){
      // Admin stays on OTP generation
    } else {
      document.getElementById("otpStep").classList.remove("hide");
    }
  } catch(e) {
    alert("Wallet connection denied.");
  }
};

// --- Admin OTP generation ---
document.getElementById("generateOtpBtn").onclick = async () => {
  const userAddr = document.getElementById("adminUserAddr").value.trim();
  let msg = document.getElementById("generatedOtpMsg");
  msg.classList.add("hide");

  if(!web3.utils.isAddress(userAddr)){
    msg.textContent = "Invalid Ethereum address.";
    msg.className = "status error";
    msg.classList.remove("hide");
    return;
  }
  try {
    // Generate random 6-digit OTP
    const otp = Math.floor(100000 + Math.random() * 900000).toString();

    // Hash the OTP
    const otpHash = web3.utils.keccak256(otp);

    // Call contract to store OTP hash for user
    await contract.methods.generateRegistrationOtp(userAddr, otpHash).send({from: userAccount});

    msg.textContent = `OTP generated: ${otp}\nSend this securely to the user.`;
    msg.className = "status success";
    msg.classList.remove("hide");
  } catch(e){
    msg.textContent = "Failed to generate OTP. Are you the contract owner?";
    msg.className = "status error";
    msg.classList.remove("hide");
    console.error(e);
  }
};

// --- OTP for Registration ---
document.getElementById("userOtp").oninput = function() {
  document.getElementById("otpBtn").disabled = this.value.trim().length === 0;
  document.getElementById("otpMsg").classList.add("hide");
};

document.getElementById("otpBtn").onclick = async function() {
  const otp = document.getElementById("userOtp").value.trim();
  let m = document.getElementById("otpMsg");
  m.classList.add("hide");
  try {
    await contract.methods.verifyUserOtp(otp).send({from:userAccount});
    document.getElementById("otpStep").classList.add("hide");
    document.getElementById("regStep").classList.remove("hide");
    document.getElementById("mainDapp").classList.remove("hide");
    otpVerified = true;
    m.textContent="OTP verified! Registration unlocked.";
    m.classList.remove("hide","error"); m.classList.add("success");
  } catch(e) {
    m.textContent = "Invalid OTP or not generated by admin for you.";
    m.classList.remove("hide","success"); m.classList.add("error");
  }
};

// --- Registration ---
document.getElementById("regForm").onsubmit = async function(e){
  e.preventDefault();
  if(!otpVerified) return alert("OTP verification required.");
  const pid=document.getElementById("pid").value.trim();
  const pname=document.getElementById("pname").value.trim();
  const manuf=document.getElementById("manuf").value.trim();
  const mfgdate=document.getElementById("mfgdate").value;
  if(!pid || !pname || !manuf || !mfgdate) return alert("All fields required.");
  let m = document.getElementById("regMsg");
  m.classList.add("hide");
  try {
    // Convert manufacture date to unix timestamp (seconds)
    const mfgTimestamp = Math.floor(new Date(mfgdate).getTime()/1000);
    await contract.methods.registerProduct(pid, pname, manuf, mfgTimestamp).send({from: userAccount});
    m.textContent = "Product registered successfully!";
    m.className = "status success";
    m.classList.remove("hide");
    this.reset();
  } catch(e) {
    m.textContent = "Failed to register product.";
    m.className = "status error";
    m.classList.remove("hide");
    console.error(e);
  }
};

// --- Product Verification & other buttons (left as original, disabled for brevity) ---

// Setup QR code scanner and handlers here if you want (not included for brevity)

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Modern Product Registry Demo with Admin OTP Generation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {background: #f2f7fa; font-family:'Montserrat',Arial,sans-serif;}
    .card {background:#fff;max-width:420px;margin:38px auto;border-radius:18px;box-shadow:0 6px 28px #b0b6d6aa;
      padding:33px 22px;}
    h1{color:#2c52d5;font-size:2.1rem;text-align:center;font-weight:800;margin-bottom:10px;}
    .step{margin-top:15px;padding:11px 6px 3px 6px;}
    label{font-weight:600; margin-top:12px;display:block;}
    input,button,textarea{width:100%;font-size:1.02rem;padding:10px 13px;margin-top:6px;margin-bottom:13px;
      border-radius:7px;border:1.1px solid #bcd9ef;background:#f6f8fc;font-family:inherit;}
    input:focus,textarea:focus{border-color:#2274f7;}
    button{background:linear-gradient(90deg,#2873e5 80%,#633de7);color:white;font-weight:700;border:none;margin-top:6px;}
    button:disabled {background:#bdd4f4;}
    .status{font-weight:700;margin:5px 0 7px 0;padding:8px 10px;border-radius:6px;}
    .success{color:#167536!important;background:#e7fae9;}
    .error{color:#a12020!important;background:#fce9e7;}
    .hide{display:none!important;}
    #qr-reader{margin:7px auto 10px auto;width:98%;max-width:295px;}
    .btnrow{display:flex;gap:9px;margin-top:12px;}
    @media (max-width:500px){.card{padding:7px 2vw;}}
  </style>
</head>
<body>
<div class="card">
  <h1>Product Registry</h1>

  <!-- Step 1: Login -->
  <div class="step" id="loginStep">
    <label>Username</label><input id="loginUser" autocomplete="username"/>
    <label>Password</label><input id="loginPwd" type="password" autocomplete="current-password"/>
    <button id="loginBtn">Login</button>
    <div id="loginMsg" class="status hide"></div>
  </div>

  <!-- Step 1.5: Admin OTP Generation (for demo, only admin wallet connected) -->
  <div class="step hide" id="adminOtpStep">
    <h3>Admin: Generate Registration OTP</h3>
    <label>User Wallet Address</label>
    <input id="adminUserAddr" placeholder="0xUserWalletAddress"/>
    <button id="generateOtpBtn">Generate OTP</button>
    <div id="generatedOtpMsg" class="status hide"></div>
  </div>

  <!-- Step 2: Wallet -->
  <div class="step hide" id="walletStep">
    <button id="connectBtn">ðŸ”‘ Connect MetaMask Wallet</button>
    <span id="walletDisp" style="display:block;margin-top:3px;color:#238454;font-weight:600;"></span>
    <div id="walletMsg" class="status hide"></div>
  </div>

  <!-- Step 3: OTP to unlock Registration -->
  <div class="step hide" id="otpStep">
    <label>Registration OTP (from admin)</label>
    <input id="userOtp"/>
    <button id="otpBtn" disabled>Verify OTP to Unlock Registration</button>
    <div id="otpMsg" class="status hide"></div>
  </div>

  <!-- Step 4: Product Registration -->
  <div class="step hide" id="regStep">
    <form id="regForm" autocomplete="off">
      <label>Product ID</label><input id="pid" required />
      <label>Name</label><input id="pname" required />
      <label>Manufacturer</label><input id="manuf" required />
      <label>Manufacture Date</label><input id="mfgdate" type="date" required />
      <button type="submit">Register Product</button>
    </form>
    <div id="regMsg" class="status hide"></div>
  </div>

  <hr style="margin:21px 0;"/>

  <!-- Step 5: Product Verification, Delivery, Fraud -->
  <div class="step hide" id="mainDapp">
    <label>Verify Product (ID or QR):</label>
    <div id="qr-reader"></div>
    <input id="verifyId" placeholder="Enter or scan Product ID"/>
    <button id="verifyBtn" disabled>Verify Product</button>
    <div id="verifyMsg" class="status hide"></div>
    <div class="btnrow">
      <button id="genDelOtpBtn" disabled style="background:#fbe67c;color:#654f02;">Admin: Delivery OTP</button>
      <button id="confDelBtn" disabled style="background:#83efd8;color:#136b47;">Buyer: Confirm Delivery OTP</button>
    </div>
    <button id="fraudBtn" disabled style="margin-top:11px;background:#fadada;color:#c12125;">Report Fraud</button>
    <textarea id="fraudDetails" rows="2" class="hide" placeholder="Describe fraud (optional)"></textarea>
    <div id="fraudMsg" class="status hide"></div>
  </div>
</div>

<script>
const contractABI = [
  {inputs:[{type:"address",name:"user"},{type:"bytes32",name:"otpHash"}],name:"generateRegistrationOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"otp"}],name:"verifyUserOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"productName"},{type:"string",name:"manufacturer"},{type:"uint256",name:"mfgDate"}],name:"registerProduct",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"}],name:"verifyProduct",outputs:[
    {type:"bool",name:"exists"},{type:"string",name:"name"},{type:"string",name:"manufacturer"},{type:"uint256",name:"manufactureDate"},{type:"bool",name:"delivered"},{type:"address",name:"recipient"}],stateMutability:"view",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"address",name:"recipient"},{type:"bytes32",name:"otpHash"}],name:"generateDeliveryOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"otp"}],name:"confirmDelivery",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"details"}],name:"reportFraud",outputs:[],stateMutability:"nonpayable",type:"function"}
];
// ðŸ‘‡ Replace with your deployed contract address!
const contractAddress = "YOUR_CONTRACT_ADDRESS";

let web3, contract, userAccount, otpVerified = false;

// --- Login ---
document.getElementById("loginBtn").onclick = function() {
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPwd").value.trim();
  let m = document.getElementById("loginMsg");
  if(username === "user" && password === "password123") {
    document.getElementById("loginStep").classList.add("hide");
    document.getElementById("walletStep").classList.remove("hide");
    m.classList.add("hide");
  } else if(username === "admin" && password === "admin123") {
    // Admin login to show OTP generation UI
    document.getElementById("loginStep").classList.add("hide");
    document.getElementById("walletStep").classList.remove("hide");
    document.getElementById("adminOtpStep").classList.remove("hide");
    m.classList.add("hide");
  } else {
    m.textContent = "Invalid username or password.";
    m.className = "status error";
    m.classList.remove("hide");
  }
};

// --- Wallet ---
document.getElementById("connectBtn").onclick = async () => {
  if(!window.ethereum) return alert("Please install MetaMask");
  web3 = new Web3(window.ethereum);
  try {
    let accounts = await ethereum.request({ method: "eth_requestAccounts" });
    userAccount = accounts[0];
    contract = new web3.eth.Contract(contractABI, contractAddress);
    document.getElementById("walletDisp").textContent = userAccount.slice(0,6) + "..." + userAccount.slice(-4);
    document.getElementById("walletStep").classList.add("hide");
    // If admin OTP generation UI visible, keep it visible, else show user OTP step
    if(!document.getElementById("adminOtpStep").classList.contains("hide")){
      // Admin stays on OTP generation
    } else {
      document.getElementById("otpStep").classList.remove("hide");
    }
  } catch(e) {
    alert("Wallet connection denied.");
  }
};

// --- Admin OTP generation ---
document.getElementById("generateOtpBtn").onclick = async () => {
  const userAddr = document.getElementById("adminUserAddr").value.trim();
  let msg = document.getElementById("generatedOtpMsg");
  msg.classList.add("hide");

  if(!web3.utils.isAddress(userAddr)){
    msg.textContent = "Invalid Ethereum address.";
    msg.className = "status error";
    msg.classList.remove("hide");
    return;
  }
  try {
    // Generate random 6-digit OTP
    const otp = Math.floor(100000 + Math.random() * 900000).toString();

    // Hash the OTP
    const otpHash = web3.utils.keccak256(otp);

    // Call contract to store OTP hash for user
    await contract.methods.generateRegistrationOtp(userAddr, otpHash).send({from: userAccount});

    msg.textContent = `OTP generated: ${otp}\nSend this securely to the user.`;
    msg.className = "status success";
    msg.classList.remove("hide");
  } catch(e){
    msg.textContent = "Failed to generate OTP. Are you the contract owner?";
    msg.className = "status error";
    msg.classList.remove("hide");
    console.error(e);
  }
};

// --- OTP for Registration ---
document.getElementById("userOtp").oninput = function() {
  document.getElementById("otpBtn").disabled = this.value.trim().length === 0;
  document.getElementById("otpMsg").classList.add("hide");
};

document.getElementById("otpBtn").onclick = async function() {
  const otp = document.getElementById("userOtp").value.trim();
  let m = document.getElementById("otpMsg");
  m.classList.add("hide");
  try {
    await contract.methods.verifyUserOtp(otp).send({from:userAccount});
    document.getElementById("otpStep").classList.add("hide");
    document.getElementById("regStep").classList.remove("hide");
    document.getElementById("mainDapp").classList.remove("hide");
    otpVerified = true;
    m.textContent="OTP verified! Registration unlocked.";
    m.classList.remove("hide","error"); m.classList.add("success");
  } catch(e) {
    m.textContent = "Invalid OTP or not generated by admin for you.";
    m.classList.remove("hide","success"); m.classList.add("error");
  }
};

// --- Registration ---
document.getElementById("regForm").onsubmit = async function(e){
  e.preventDefault();
  if(!otpVerified) return alert("OTP verification required.");
  const pid=document.getElementById("pid").value.trim();
  const pname=document.getElementById("pname").value.trim();
  const manuf=document.getElementById("manuf").value.trim();
  const mfgdate=document.getElementById("mfgdate").value;
  if(!pid || !pname || !manuf || !mfgdate) return alert("All fields required.");
  let m = document.getElementById("regMsg");
  m.classList.add("hide");
  try {
    // Convert manufacture date to unix timestamp (seconds)
    const mfgTimestamp = Math.floor(new Date(mfgdate).getTime()/1000);
    await contract.methods.registerProduct(pid, pname, manuf, mfgTimestamp).send({from: userAccount});
    m.textContent = "Product registered successfully!";
    m.className = "status success";
    m.classList.remove("hide");
    this.reset();
  } catch(e) {
    m.textContent = "Failed to register product.";
    m.className = "status error";
    m.classList.remove("hide");
    console.error(e);
  }
};

// --- Product Verification & other buttons (left as original, disabled for brevity) ---

// Setup QR code scanner and handlers here if you want (not included for brevity)

</script>
</body>
</html>
