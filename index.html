<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Authenticity & Fraud Reporting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { background: #f8fbfd; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0;}
    .container { max-width: 430px; margin: 40px auto 0 auto;
      background: #fff; border-radius: 16px; box-shadow: 0 8px 40px #9fb0c31a;
      padding: 32px 22px 28px 22px;}
    h1 { color: #1862c5; font-size: 2rem; text-align: center; margin-bottom: 6px; font-weight: 600;}
    .caption { text-align:center; color:#536178; margin-bottom:30px;}
    label { font-weight:600; color:#3d5170; margin-top:12px;}
    input,button,select,textarea {
      margin-top:7px; margin-bottom:14px;
      font-size:1rem; padding:9px 12px;
      border:1.3px solid #cadefd;
      border-radius:6px; width:100%; background:#f7f9fd;
      outline:none; box-sizing: border-box;
      font-family: inherit; transition: border .2s;}
    input:focus, textarea:focus { border-color:#448AFF; background: #eaf3ff;}
    button {
      background: linear-gradient(90deg,#2e6bdf 80%,#1567ca); color: #fff;
      font-weight: 600; cursor: pointer; border:none;
      margin-top:10px; letter-spacing:.5px; transition: background .15s;}
    button:disabled { background: #aac7f6; cursor:not-allowed;}
    textarea{ resize:vertical; min-height:48px; }
    .statusMsg  {font-weight:500;margin-top:10px; padding:11px 15px; border-radius:6px; font-size:1rem; display:block;}
    .success {background: #e6fcf1; color:#00683a; border:1.2px solid #30dc97;}
    .error   {background: #ffe8e7; color:#d12023; border:1.2px solid #ff5858;}
    #qr-reader {margin: 10px auto 16px auto; width:90%;max-width:265px;}
    hr {margin:30px 0 20px 0; border-color: #ebf1f9;}
    .titleBar { display:flex; align-items:center; gap: 6px; margin-bottom:16px;}
    .iconBox { background: linear-gradient(135deg,#38b6ff90,#0039a7bb 65%);
      color: #fff; font-weight:700; width:34px;height:34px;
      display:flex;align-items:center;justify-content:center; font-size:1.22rem;
      border-radius:9px 2px 13px 2px;}
    .section {margin-bottom:35px;}
    .flexrow { display:flex;gap:13px;}
    .fraudLink {color:#dc4747; cursor:pointer; text-decoration:underline; font-size:.98rem;}
    @media (max-width:500px){.container{padding:17px 4vw;}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Verify Product</h1>
    <div class="caption">Secure your order‚Äîscan and verify. If cheated, complain instantly to the blockchain.</div>
    <div id="walletBar" class="flexrow" style="margin-bottom:15px;">
      <button id="connectBtn">üîó Connect Wallet</button>
      <span id="walletAddress" style="color:#117422;align-self:center;white-space:nowrap;"></span>
    </div>

    <div class="section">
      <div class="titleBar">
        <span class="iconBox">üìù</span>
        <span style="font-size:1.12rem; font-weight:600; color:#176bcc">Admin: Register Product</span>
      </div>
      <form id="regForm">
        <label for="pid">Product ID</label>
        <input id="pid" type="text" required placeholder="e.g. ZX900221" />
        <label for="pname">Product Name</label>
        <input id="pname" type="text" required placeholder="e.g. Luxury Watch" />
        <label for="manuf">Manufacturer</label>
        <input id="manuf" type="text" required placeholder="e.g. Rolex SA" />
        <label for="mfgdate">Manufacture Date</label>
        <input type="date" id="mfgdate" required />
        <button type="submit">Register Product</button>
      </form>
      <div style="display:none" id="regResult" class="statusMsg"></div>
    </div>

    <hr />

    <div class="section">
      <div class="titleBar">
        <span class="iconBox">üîç</span>
        <span style="font-size:1.12rem; font-weight:600; color:#176bcc">Scan & Verify Product</span>
      </div>
      <div id="qr-reader"></div>
      <input type="text" id="vpid" placeholder="Paste or scan Product ID" autocomplete="off"/>
      <button id="verifyBtn" disabled>Verify Product</button>
      <div style="display:none" id="verifyResult" class="statusMsg"></div>
      <div style="margin-top:7px;">
        <span class="fraudLink" id="fraudTrigger">‚ùóReport Fraudulent/Wrong Product Delivery</span>
      </div>
    </div>

    <!-- Fraud Report Modal -->
    <div id="fraudModal" style="display:none;position:fixed;z-index:10;top:0;left:0;width:100vw;height:100vh;background:#232941dd;justify-content:center;align-items:center;">
      <div style="background:#fff;padding:25px 20px;max-width:360px;border-radius:13px;box-shadow:0 8px 48px #1d193155;">
        <div style="font-size:1.13rem;font-weight:600;color:#af383a;margin-bottom:10px;">Report a Delivery Fraud</div>
        <label>Your Product ID</label>
        <input type="text" id="fraud_pid" readonly />
        <label style="margin-top:8px;">What went wrong?</label>
        <textarea id="fraud_details" placeholder="Describe the issue (e.g. Received wrong/fake product, empty box...)"></textarea>
        <div class="flexrow" style="margin-top:9px;">
          <button style="background:#e46e68;" id="sendFraud">Send Report</button>
          <button style="background:#c5dfff; color:#214baa;" id="closeFraud">Cancel</button>
        </div>
        <div id="fraudStatus" class="statusMsg" style="margin-top:9px;display:none"></div>
      </div>
    </div>

  </div>
  <script>
    // -------- CONTRACT ABI and ADDRESS (set your own deployed address) ---------
    const contractABI = [
      {
        "inputs":[
          {"internalType":"string","name":"productId","type":"string"},
          {"internalType":"string","name":"productName","type":"string"},
          {"internalType":"string","name":"manufacturer","type":"string"},
          {"internalType":"uint256","name":"mfgDate","type":"uint256"}
        ],
        "name":"registerProduct", "outputs":[], "stateMutability":"nonpayable", "type":"function"
      },
      {
        "inputs":[{"internalType":"string","name":"productId","type":"string"}],
        "name":"verifyProduct","outputs":[
          {"internalType":"bool","name":"exists","type":"bool"},
          {"internalType":"string","name":"name","type":"string"},
          {"internalType":"string","name":"manufacturer","type":"string"},
          {"internalType":"uint256","name":"manufactureDate","type":"uint256"}
        ],
        "stateMutability":"view","type":"function"
      },
      {
        "inputs":[
          {"internalType":"string","name":"productId","type":"string"},
          {"internalType":"string","name":"details","type":"string"}
        ],
        "name":"reportFraud", "outputs":[], "stateMutability":"nonpayable", "type":"function"
      }
    ];
    const contractAddress = "0x04949140bc1d5171e254d221a73b6a2590583921"; // <-- Set after deployment

    let web3, contract, userAccount;

    document.getElementById('connectBtn').onclick = async function () {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          await ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await web3.eth.getAccounts();
          userAccount = accounts[0];
          document.getElementById("walletAddress").textContent = userAccount.slice(0,6) + "..." + userAccount.slice(-4);
          contract = new web3.eth.Contract(contractABI, contractAddress);
          document.getElementById('verifyBtn').disabled = false;
        } catch (err) {
          alert("Wallet connection denied.");
        }
      } else {
        alert("Please install MetaMask extension!");
      }
    };

    document.getElementById('regForm').onsubmit = async function(e){
      e.preventDefault();
      if (!contract || !userAccount) return alert("Connect wallet!");
      const pid = document.getElementById('pid').value.trim();
      const pname = document.getElementById('pname').value.trim();
      const manuf = document.getElementById('manuf').value.trim();
      const mfgDateStr = document.getElementById('mfgdate').value;
      const regDiv = document.getElementById('regResult');
      regDiv.style.display = 'block';
      regDiv.className = "statusMsg";
      if (!mfgDateStr) return regDiv.textContent = "Enter manufacture date!";
      const mfgDate = Math.floor(new Date(mfgDateStr).getTime() / 1000);
      try {
        await contract.methods.registerProduct(pid, pname, manuf, mfgDate).send({from: userAccount});
        regDiv.textContent = "‚úÖ Product registered successfully!";
        regDiv.classList.add("success");
        regDiv.classList.remove("error");
        e.target.reset();
      } catch (e) {
        regDiv.textContent = "‚ùå Registration failed. Only contract owner can register.";
        regDiv.classList.add("error");
        regDiv.classList.remove("success");
      }
    };

    // --- QR code scanner ---
    const scanner = new Html5Qrcode("qr-reader");
    Html5Qrcode.getCameras().then(devs => {
      if (devs && devs.length) {
        scanner.start(
          { deviceId: {exact: devs[0].id} },
          { fps: 10, qrbox: 220 },
          decodedText => { document.getElementById('vpid').value = decodedText; },
          err => {}
        ).catch(() => {
          document.getElementById('verifyResult').style.display='block';
          document.getElementById('verifyResult').textContent='‚ùå Could not open camera.';
          document.getElementById('verifyResult').className='statusMsg error';
        });
      }
    });

    document.getElementById('verifyBtn').onclick = async function(){
      if(!contract){alert("Connect wallet first."); return;}
      const pid = document.getElementById('vpid').value.trim();
      const resultDiv = document.getElementById('verifyResult');
      resultDiv.style.display='block';
      resultDiv.className="statusMsg";
      if(!pid){resultDiv.textContent="‚ùå Enter or scan a Product ID.";resultDiv.classList.add("error");return;}
      try {
        const res = await contract.methods.verifyProduct(pid).call();
        if(res[0]){
          const date = new Date(res[3]*1000);
          resultDiv.innerHTML = `
            ‚úÖ <b>Product is Authentic</b><br>
            Name: <b>${res[1]}</b><br>
            Manufacturer: <b>${res[2]}</b><br>
            Manufacture Date: <b>${date.toLocaleDateString()}</b>
          `;
          resultDiv.classList.add("success");
          resultDiv.classList.remove("error");
        }else{
          resultDiv.textContent = "‚ùå Product not found on blockchain (may be fake). You may raise a fraud report.";
          resultDiv.classList.add("error");
          resultDiv.classList.remove("success");
        }
      }catch(e){
        resultDiv.textContent = "‚ùå Error verifying product.";
        resultDiv.classList.add("error");
        resultDiv.classList.remove("success");
      }
    };

    // FRAUD REPORT WORKFLOW
    document.getElementById('fraudTrigger').onclick = function(){
      document.getElementById('fraudModal').style.display='flex';
      document.getElementById('fraud_pid').value = document.getElementById('vpid').value.trim();
      document.getElementById('fraud_details').value = '';
      document.getElementById('fraudStatus').style.display='none';
    };
    document.getElementById('closeFraud').onclick = function(){
      document.getElementById('fraudModal').style.display='none';
    };
    document.getElementById('sendFraud').onclick = async function(){
      const pid = document.getElementById('fraud_pid').value.trim();
      const details = document.getElementById('fraud_details').value.trim();
      const stat = document.getElementById('fraudStatus');
      stat.style.display='block'; stat.textContent="Sending...";
      stat.className="statusMsg";
      if(!pid) {stat.textContent="Enter Product ID!"; stat.classList.add('error');return;}
      if(!details) {stat.textContent="Please describe your complaint."; stat.classList.add('error');return;}
      try{
        await contract.methods.reportFraud(pid, details).send({from:userAccount});
        stat.textContent="‚úÖ Fraud complaint sent. Your report is now on the blockchain.";
        stat.classList.add('success');stat.classList.remove('error');
      }catch(e){
        stat.textContent="‚ùå Failed to submit fraud report. Try again.";
        stat.classList.add('error');stat.classList.remove('success');
      }
    };
  </script>
</body>
</html>
