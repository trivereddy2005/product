<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Registry with Admin OTP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <style>
    body {
      background: #f2f7fa;
      font-family: "Montserrat", Arial, sans-serif;
    }
    .card {
      background: #fff;
      max-width: 420px;
      margin: 38px auto;
      border-radius: 18px;
      box-shadow: 0 6px 28px #b0b6d6aa;
      padding: 33px 22px;
    }
    h1 {
      color: #2c52d5;
      font-size: 2.1rem;
      text-align: center;
      font-weight: 800;
      margin-bottom: 10px;
    }
    .step {
      margin-top: 15px;
      padding: 11px 6px 3px 6px;
    }
    label {
      font-weight: 600;
      margin-top: 12px;
      display: block;
    }
    input,
    button {
      width: 100%;
      font-size: 1.02rem;
      padding: 10px 13px;
      margin-top: 6px;
      margin-bottom: 13px;
      border-radius: 7px;
      border: 1.1px solid #bcd9ef;
      background: #f6f8fc;
      font-family: inherit;
    }
    input:focus {
      border-color: #2274f7;
      outline: none;
    }
    button {
      background: linear-gradient(90deg, #2873e5 80%, #633de7);
      color: white;
      font-weight: 700;
      border: none;
      margin-top: 6px;
      cursor: pointer;
    }
    button:disabled {
      background: #bdd4f4;
      cursor: not-allowed;
    }
    .status {
      font-weight: 700;
      margin: 5px 0 7px 0;
      padding: 8px 10px;
      border-radius: 6px;
    }
    .success {
      color: #167536 !important;
      background: #e7fae9;
    }
    .error {
      color: #a12020 !important;
      background: #fce9e7;
    }
    .hide {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Product Registry</h1>

    <!-- Login -->
    <div class="step" id="loginStep">
      <label>Username</label>
      <input id="loginUser" autocomplete="username" />
      <label>Password</label>
      <input id="loginPwd" type="password" autocomplete="current-password" />
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="status hide"></div>
    </div>

    <!-- Admin OTP generation -->
    <div class="step hide" id="adminOtpStep">
      <h3>Admin: Generate Registration OTP</h3>
      <label>User Wallet Address</label>
      <input id="adminUserAddr" placeholder="0xUserWalletAddress" />
      <button id="generateOtpBtn">Generate OTP</button>
      <div id="generatedOtpMsg" class="status hide"></div>
    </div>

    <!-- Wallet connect -->
    <div class="step hide" id="walletStep">
      <button id="connectBtn">ðŸ”‘ Connect MetaMask Wallet</button>
      <span
        id="walletDisp"
        style="display:block; margin-top: 3px; color: #238454; font-weight: 600;"
      ></span>
      <div id="walletMsg" class="status hide"></div>
    </div>

    <!-- OTP verification -->
    <div class="step hide" id="otpStep">
      <label>Registration OTP (from admin)</label>
      <input id="userOtp" />
      <button id="otpBtn" disabled>Verify OTP to Unlock Registration</button>
      <div id="otpMsg" class="status hide"></div>
    </div>

    <!-- Product Registration -->
    <div class="step hide" id="regStep">
      <form id="regForm" autocomplete="off">
        <label>Product ID</label>
        <input id="pid" required />
        <label>Name</label>
        <input id="pname" required />
        <label>Manufacturer</label>
        <input id="manuf" required />
        <label>Manufacture Date</label>
        <input id="mfgdate" type="date" required />
        <button type="submit">Register Product</button>
      </form>
      <div id="regMsg" class="status hide"></div>
    </div>
  </div>

  <script>
    // Replace with your contract ABI & address
    const contractABI = [
      [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "otp",
				"type": "string"
			}
		],
		"name": "confirmDelivery",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			}
		],
		"name": "DeliveryConfirmed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			}
		],
		"name": "DeliveryOtpGenerated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "reporter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "details",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "FraudReported",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			},
			{
				"internalType": "bytes32",
				"name": "otpHash",
				"type": "bytes32"
			}
		],
		"name": "generateDeliveryOtp",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"internalType": "bytes32",
				"name": "otpHash",
				"type": "bytes32"
			}
		],
		"name": "generateRegistrationOtp",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "manufacturer",
				"type": "string"
			}
		],
		"name": "ProductRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "manufacturer",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "mfgDate",
				"type": "uint256"
			}
		],
		"name": "registerProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "RegistrationOtpGenerated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "productId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "details",
				"type": "string"
			}
		],
		"name": "reportFraud",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "UserVerified",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "otp",
				"type": "string"
			}
		],
		"name": "verifyUserOtp",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "productId",
				"type": "string"
			}
		],
		"name": "verifyProduct",
		"outputs": [
			{
				"internalType": "bool",
				"name": "exists",
				"type": "bool"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "manufacturer",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "manufactureDate",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "delivered",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
    ];
    const contractAddress = "0xf94ac6fe1bc75a7462cc5f7f9e14a5d281f1b46b";

    let web3, contract, userAccount, otpVerified = false;

    // Login
    document.getElementById("loginBtn").onclick = () => {
      const username = document.getElementById("loginUser").value.trim();
      const password = document.getElementById("loginPwd").value.trim();
      const m = document.getElementById("loginMsg");

      if (username === "admin" && password === "admin123") {
        document.getElementById("loginStep").classList.add("hide");
        document.getElementById("walletStep").classList.remove("hide");
        document.getElementById("adminOtpStep").classList.remove("hide");
        m.classList.add("hide");
      } else if (username === "user" && password === "password123") {
        document.getElementById("loginStep").classList.add("hide");
        document.getElementById("walletStep").classList.remove("hide");
        m.classList.add("hide");
      } else {
        m.textContent = "Invalid username or password.";
        m.className = "status error";
        m.classList.remove("hide");
      }
    };

    // Connect Wallet
    document.getElementById("connectBtn").onclick = async () => {
      if (!window.ethereum) {
        alert("Please install MetaMask!");
        return;
      }
      web3 = new Web3(window.ethereum);
      try {
        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        userAccount = accounts[0];
        contract = new web3.eth.Contract(contractABI, contractAddress);
        document.getElementById("walletDisp").textContent =
          userAccount.slice(0, 6) + "..." + userAccount.slice(-4);
        document.getElementById("walletStep").classList.add("hide");

        // Show OTP step for users, Admin stays at OTP generation step
        if (document.getElementById("adminOtpStep").classList.contains("hide")) {
          document.getElementById("otpStep").classList.remove("hide");
        }
      } catch (error) {
        alert("Wallet connection denied.");
      }
    };

    // Admin generates OTP
    document.getElementById("generateOtpBtn").onclick = async () => {
      const userAddr = document.getElementById("adminUserAddr").value.trim();
      const msg = document.getElementById("generatedOtpMsg");
      msg.classList.add("hide");

      if (!web3.utils.isAddress(userAddr)) {
        msg.textContent = "Invalid Ethereum address.";
        msg.className = "status error";
        msg.classList.remove("hide");
        return;
      }

      try {
        // Generate random 6-digit OTP
        const otp = Math.floor(100000 + Math.random() * 900000).toString();

        // Hash OTP using keccak256
        const otpHash = web3.utils.keccak256(otp);

        // Send OTP hash to contract with admin wallet
        await contract.methods.generateRegistrationOtp(userAddr, otpHash).send({ from: userAccount });

        msg.textContent = `OTP generated: ${otp}\nSend this securely to the user.`;
        msg.className = "status success";
        msg.classList.remove("hide");
      } catch (e) {
        msg.textContent = "Failed to generate OTP. Are you the contract owner?";
        msg.className = "status error";
        msg.classList.remove("hide");
        console.error(e);
      }
    };

    // Enable OTP button when user types OTP
    document.getElementById("userOtp").oninput = function () {
      document.getElementById("otpBtn").disabled = this.value.trim().length === 0;
      document.getElementById("otpMsg").classList.add("hide");
    };

    // User verifies OTP
    document.getElementById("otpBtn").onclick = async () => {
      const otp = document.getElementById("userOtp").value.trim();
      const m = document.getElementById("otpMsg");
      m.classList.add("hide");
      try {
        await contract.methods.verifyUserOtp(otp).send({ from: userAccount });

        document.getElementById("otpStep").classList.add("hide");
        document.getElementById("regStep").classList.remove("hide");
        otpVerified = true;
        m.textContent = "OTP verified! Registration unlocked.";
        m.className = "status success";
        m.classList.remove("hide");
      } catch (e) {
        m.textContent = "Invalid OTP or not generated by admin for you.";
        m.className = "status error";
        m.classList.remove("hide");
      }
    };

    // Product registration form submission
    document.getElementById("regForm").onsubmit = async (e) => {
      e.preventDefault();
      if (!otpVerified) {
        alert("Please verify OTP before registering a product.");
        return;
      }
      const pid = document.getElementById("pid").value.trim();
      const pname = document.getElementById("pname").value.trim();
      const manuf = document.getElementById("manuf").value.trim();
      const mfgdate = document.getElementById("mfgdate").value;

      if (!pid || !pname || !manuf || !mfgdate) {
        alert("All fields are required.");
        return;
      }

      const m = document.getElementById("regMsg");
      m.classList.add("hide");

      try {
        const mfgTimestamp = Math.floor(new Date(mfgdate).getTime() / 1000);
        await contract.methods
          .registerProduct(pid, pname, manuf, mfgTimestamp)
          .send({ from: userAccount });
        m.textContent = "Product registered successfully!";
        m.className = "status success";
        m.classList.remove("hide");
        e.target.reset();
      } catch (err) {
        m.textContent = "Failed to register product.";
        m.className = "status error";
        m.classList.remove("hide");
        console.error(err);
      }
    };
  </script>
</body>
</html>
